name: Auto-Issue on Failure

on:
  workflow_run:
    workflows: ["Autonomous Development CI/CD"]
    types:
      - completed

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  create-issue-on-failure:
    name: Create Issue on CI Failure
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Analyze failure
        id: analyze
        run: |
          # Get workflow run details
          WORKFLOW_URL="${{ github.event.workflow_run.html_url }}"
          BRANCH="${{ github.event.workflow_run.head_branch }}"
          COMMIT="${{ github.event.workflow_run.head_sha }}"

          echo "workflow_url=$WORKFLOW_URL" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "commit=$COMMIT" >> $GITHUB_OUTPUT

          # Determine failure type
          if [[ "$WORKFLOW_URL" == *"security"* ]]; then
            echo "failure_type=security" >> $GITHUB_OUTPUT
            echo "priority=critical" >> $GITHUB_OUTPUT
          elif [[ "$WORKFLOW_URL" == *"test"* ]]; then
            echo "failure_type=test" >> $GITHUB_OUTPUT
            echo "priority=high" >> $GITHUB_OUTPUT
          else
            echo "failure_type=general" >> $GITHUB_OUTPUT
            echo "priority=medium" >> $GITHUB_OUTPUT
          fi

      - name: Create failure issue
        uses: actions/github-script@v6
        with:
          script: |
            const failureType = '${{ steps.analyze.outputs.failure_type }}';
            const priority = '${{ steps.analyze.outputs.priority }}';
            const workflowUrl = '${{ steps.analyze.outputs.workflow_url }}';
            const branch = '${{ steps.analyze.outputs.branch }}';
            const commit = '${{ steps.analyze.outputs.commit }}';

            const labels = ['automated', 'ci-failure', priority];
            if (failureType === 'security') {
              labels.push('security');
            } else if (failureType === 'test') {
              labels.push('bug');
            }

            const title = `üö® CI Failure: ${failureType} on ${branch}`;

            const body = `## CI/CD Pipeline Failure

            **Type**: ${failureType}
            **Priority**: ${priority}
            **Branch**: \`${branch}\`
            **Commit**: \`${commit.substring(0, 7)}\`

            ### Failure Details

            - **Workflow Run**: [View Details](${workflowUrl})
            - **Time**: ${new Date().toISOString()}

            ### Next Steps

            ${ priority === 'critical' ? '‚ö†Ô∏è **CRITICAL**: This requires immediate attention!' : ''}

            1. Review the [workflow logs](${workflowUrl})
            2. Identify the root cause
            3. Apply fixes
            4. Trigger auto-fix workflow if applicable

            ### Auto-Fix Status

            - [ ] Failure analyzed
            - [ ] Auto-fix attempted
            - [ ] Manual intervention required

            ---

            ü§ñ *This issue was automatically created by the autonomous development system*

            **Commands**:
            - \`/auto-fix\` - Trigger automated fix attempt
            - \`/assign-agent <agent-name>\` - Assign to specific agent
            - \`/close\` - Close if resolved externally
            `;

            // Check if similar issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'ci-failure',
              per_page: 100
            });

            const existingIssue = issues.data.find(issue =>
              issue.title.includes(failureType) && issue.title.includes(branch)
            );

            if (existingIssue) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `### New Failure Occurrence\n\n**Commit**: \`${commit.substring(0, 7)}\`\n**Time**: ${new Date().toISOString()}\n**Workflow**: [View Details](${workflowUrl})`
              });

              console.log(`Updated existing issue #${existingIssue.number}`);
            } else {
              // Create new issue
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: labels
              });

              console.log(`Created issue #${issue.data.number}`);
            }

      - name: Trigger auto-fix workflow
        if: steps.analyze.outputs.failure_type != 'security'
        uses: actions/github-script@v6
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'auto-fix.yaml',
              ref: '${{ steps.analyze.outputs.branch }}',
              inputs: {
                failure_type: '${{ steps.analyze.outputs.failure_type }}',
                commit: '${{ steps.analyze.outputs.commit }}',
                workflow_url: '${{ steps.analyze.outputs.workflow_url }}'
              }
            });

      - name: Send notification
        if: steps.analyze.outputs.priority == 'critical'
        run: |
          echo "üö® CRITICAL CI FAILURE DETECTED"
          echo "Type: ${{ steps.analyze.outputs.failure_type }}"
          echo "Branch: ${{ steps.analyze.outputs.branch }}"
          echo "Issue has been created and auto-fix triggered"
          # In production, send to Slack/Email/PagerDuty
