name: Release

on:
  workflow_call:  # ä»–ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‹ã‚‰å‘¼ã³å‡ºã—å¯èƒ½
    inputs:
      version:
        description: 'Version to release'
        required: true
        type: string
  push:
    tags:
      - 'v*'  # v1.0.0, v1.2.3 ç­‰ã®ã‚¿ã‚°ã§ãƒˆãƒªã‚¬ãƒ¼ï¼ˆæ‰‹å‹•ã‚¿ã‚°pushç”¨ï¼‰
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.1.0)'
        required: true
        type: string

permissions:
  contents: write  # GitHub Releasesã¸ã®æ›¸ãè¾¼ã¿

jobs:
  goreleaser:
    runs-on: ubuntu-latest
    outputs:
      skip: ${{ steps.version.outputs.skip }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å…¨å±¥æ­´å–å¾—ï¼ˆchangelogã«å¿…è¦ï¼‰
          ref: ${{ github.event_name == 'workflow_call' && 'main' || '' }}  # workflow_callã®å ´åˆã¯æœ€æ–°ã®mainã‚’å–å¾—

      - name: Set version
        id: version
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if [ -n "${{ inputs.version }}" ]; then
            # workflow_call ã¾ãŸã¯ workflow_dispatch: æ¸¡ã•ã‚ŒãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½¿ç”¨
            VERSION="${{ inputs.version }}"
            echo "ðŸ“¥ Using version from input: ${VERSION}"
          elif [ "${{ github.ref_type }}" = "tag" ]; then
            # ã‚¿ã‚°ãƒ—ãƒƒã‚·ãƒ¥: ã‚¿ã‚°ã‹ã‚‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—
            VERSION=${GITHUB_REF#refs/tags/v}
            echo "ðŸ·ï¸  Using version from tag: ${VERSION}"
          else
            # mainãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥: VERSIONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿å–ã‚Š
            VERSION=$(cat VERSION | tr -d '\n')
            echo "ðŸ“„ Using version from VERSION file: ${VERSION}"

            # æ—¢ã«åŒã˜ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã‚¿ã‚°ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            if git ls-remote --tags origin | grep -q "refs/tags/v${VERSION}$"; then
              echo "âš ï¸  Tag v${VERSION} already exists. Skipping release."
              echo "skip=true" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi

          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "skip=false" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Releasing version: ${VERSION}"

          # ã‚¿ã‚°ãŒå­˜åœ¨ã—ãªã„å ´åˆã®ã¿ä½œæˆ
          if ! git rev-parse "v${VERSION}" >/dev/null 2>&1; then
            git tag -a "v${VERSION}" -m "Release v${VERSION}"
            git push origin "v${VERSION}"
            echo "âœ… Created and pushed tag v${VERSION}"
          else
            echo "â„¹ï¸  Tag v${VERSION} already exists"
          fi

          # Ensure we're on the tagged commit
          git checkout "v${VERSION}"

      - name: Setup Go
        if: steps.version.outputs.skip != 'true'
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Run tests
        if: steps.version.outputs.skip != 'true'
        run: |
          go mod download
          go test ./...

      - name: Run GoReleaser
        if: steps.version.outputs.skip != 'true'
        uses: goreleaser/goreleaser-action@v5
        with:
          distribution: goreleaser
          version: latest
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-npm:
    needs: goreleaser
    runs-on: ubuntu-latest
    # Publish to npm if NPM_TOKEN is configured
    if: needs.goreleaser.outputs.skip != 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version
        id: get_version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            # workflow_call ã¾ãŸã¯ workflow_dispatch: æ¸¡ã•ã‚ŒãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½¿ç”¨
            VERSION="${{ inputs.version }}"
          elif [ "${{ github.ref_type }}" = "tag" ]; then
            # ã‚¿ã‚°ãƒ—ãƒƒã‚·ãƒ¥: ã‚¿ã‚°ã‹ã‚‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            # VERSIONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿å–ã‚Š
            VERSION=$(cat VERSION | tr -d '\n')
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: 'https://registry.npmjs.org'

      - name: Update npm package version
        run: |
          cd npm
          npm version ${{ steps.get_version.outputs.version }} --no-git-tag-version

      - name: Publish to npm
        run: |
          cd npm
          npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
