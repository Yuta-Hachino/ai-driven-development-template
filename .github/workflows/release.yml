name: Release

on:
  push:
    branches:
      - main  # mainã¸ã®ãƒžãƒ¼ã‚¸ã§è‡ªå‹•ãƒªãƒªãƒ¼ã‚¹
    paths:
      - 'VERSION'  # VERSIONãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚ŒãŸæ™‚ã®ã¿
    tags:
      - 'v*'  # v1.0.0, v1.2.3 ç­‰ã®ã‚¿ã‚°ã§ãƒˆãƒªã‚¬ãƒ¼ï¼ˆå¾Œæ–¹äº’æ›ï¼‰
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.1.0)'
        required: true
        type: string

permissions:
  contents: write  # GitHub Releasesã¸ã®æ›¸ãè¾¼ã¿
  packages: write  # GitHub Packagesã¸ã®æ›¸ãè¾¼ã¿ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

jobs:
  goreleaser:
    runs-on: ubuntu-latest
    outputs:
      skip: ${{ steps.version.outputs.skip }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å…¨å±¥æ­´å–å¾—ï¼ˆchangelogã«å¿…è¦ï¼‰

      - name: Set version
        id: version
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼: å…¥åŠ›ã•ã‚ŒãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½¿ç”¨
            VERSION="${{ github.event.inputs.version }}"
          elif [ "${{ github.ref_type }}" = "tag" ]; then
            # ã‚¿ã‚°ãƒ—ãƒƒã‚·ãƒ¥: ã‚¿ã‚°ã‹ã‚‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            # mainãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥: VERSIONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿å–ã‚Š
            VERSION=$(cat VERSION | tr -d '\n')

            # æ—¢ã«åŒã˜ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã‚¿ã‚°ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            if git ls-remote --tags origin | grep -q "refs/tags/v${VERSION}$"; then
              echo "âš ï¸  Tag v${VERSION} already exists. Skipping release."
              echo "skip=true" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi

          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "skip=false" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Releasing version: ${VERSION}"

          # ã‚¿ã‚°ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆã—ã¦push
          if ! git rev-parse "v${VERSION}" >/dev/null 2>&1; then
            git tag -a "v${VERSION}" -m "Release v${VERSION}"
            git push origin "v${VERSION}"
            echo "âœ… Created and pushed tag v${VERSION}"
          else
            echo "â„¹ï¸  Tag v${VERSION} already exists locally"
          fi

          # Ensure we're on the tagged commit
          git checkout "v${VERSION}"

      - name: Setup Go
        if: steps.version.outputs.skip != 'true'
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Run tests
        if: steps.version.outputs.skip != 'true'
        run: |
          go mod download
          go test ./...

      - name: Run GoReleaser
        if: steps.version.outputs.skip != 'true'
        uses: goreleaser/goreleaser-action@v5
        with:
          distribution: goreleaser
          version: latest
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-npm:
    needs: goreleaser
    runs-on: ubuntu-latest
    # Only run if NPM_TOKEN secret is configured
    # To enable: Set NPM_TOKEN in repository secrets and uncomment the 'if' line below
    if: false  # Disabled until @autonomous-dev scope is created on npmjs.org
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [ "${{ github.ref_type }}" = "tag" ]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION=$(cat VERSION | tr -d '\n')
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: 'https://registry.npmjs.org'

      - name: Update npm package version
        run: |
          cd npm
          npm version ${{ steps.get_version.outputs.version }} --no-git-tag-version

      - name: Publish to npm
        run: |
          cd npm
          npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
